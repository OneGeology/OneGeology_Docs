

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Using the MS4W Apache http server as a reverse proxy to Tomcat &mdash; OneGeology Documentation 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/OneGeology_favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OneGeology English keyword dictionary picklist" href="appendixi.html" />
    <link rel="prev" title="WMS 1.1.1 GetCapabilities response from the BGS OneGeology exemplars service" href="appendixg.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OneGeology Documentation
          

          
            
            <img src="../_static/Onegeology_logo_large.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../providingdata.html">Providing Data / Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../portal.html">Using the OneGeology Portal</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../appendices.html">Appendices</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="appendixa.html">Converting coordinate system in data files</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixb.html">Creating MapServer CLASS definitions from ArcView legends</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixc.html">Creating MapServer CLASS definitions from ARCGIS legends</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixd.html">Creating MapServer CLASS definitions using QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixe.html">BGS example service map file</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixf.html">WMS 1.3.0 GetCapabilities response from the BGS OneGeology exemplars service</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixg.html">WMS 1.1.1 GetCapabilities response from the BGS OneGeology exemplars service</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using the MS4W Apache http server as a reverse proxy to Tomcat</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixi.html">OneGeology English keyword dictionary picklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixj.html">How to create a Styled Layer Descriptor (SLD) using Arc2Earth</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixk.html">Recommend ESRI shapefile definitions for GeoSciML-Portrayal</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixl.html">Mapping OneGeology-Europe data model to GeoSciML-Portrayal | OneGeology</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendixL_1.html">Considerations for converting a MapServer based OneGeology-Europe service | OneGeology</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Authors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OneGeology Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../appendices.html">Appendices</a> &raquo;</li>
        
      <li>Using the MS4W Apache http server as a reverse proxy to Tomcat</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/appendices/appendixh.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-the-ms4w-apache-http-server-as-a-reverse-proxy-to-tomcat">
<h1>Using the MS4W Apache http server as a reverse proxy to Tomcat<a class="headerlink" href="#using-the-ms4w-apache-http-server-as-a-reverse-proxy-to-tomcat" title="Permalink to this headline">¶</a></h1>
<div class="docutils container" id="outer-container">
<div class="docutils container" id="content">
<div class="fullwidth docutils container">
<p class="technical-progress-side-menu rubric" id="appendix-h-using-the-ms4w-apache-http-server-as-a-reverse-proxy-to-tomcat">Appendix H: Using the MS4W Apache http server as a
reverse proxy to Tomcat</p>
<p>To serve a OneGeology WMS through the OneGeology Portal that
service must be served using port 80; the default port for any
http web service. If you are already serving another web
service on port 80 on the same server (such as a GeoNetwork
spatial data metadata catalogue for example), then you will
need to use a different port number for the existing service.
In itself this shouldn’t be too difficult to do, however this
might cause problems for your customers due to restrictive
firewall rules that prevent them consuming any web service not
served on the standard web port number. One way around this is
to merge the services together; another possibility (as
detailed below) is to use the Apache HTTP web server as a
reverse proxy, that is, to handle all requests to the second
service as if that service was coming from the MS4W Apache
service. The user is thus unaware that there is more than one
web service. Each service proxied in this way runs on a
separate port number, and may still be accessed directly on
that port (depending on your configuration), but it is also
available as if it were running on port 80.</p>
<p><a class="reference external" href="http://httpd.apache.org/docs/2.2/urlmapping.html">Comprehensive information on configuring
Apache</a>
(<a class="reference external" href="http://httpd.apache.org/docs/2.2/urlmapping.html">http://httpd.apache.org/docs/2.2/urlmapping.html</a>).</p>
<p>The first step is to change the <a class="reference external" href="http://www.iana.org/assignments/port-numbers">port
numbers</a>
(<a class="reference external" href="http://www.iana.org/assignments/port-numbers">http://www.iana.org/assignments/port-numbers</a>) on which your
other web servers work; in this example we have two other web
services (a Tomcat based web service which we will run on port
8080, and a jetty based web service which we will run on port
8008). Note that both these ports are recognized alternate
ports for http traffic but they may not be open to such traffic
in your corporate firewall.</p>
<p>Now we need to edit the Apache HTTP server httpd.conf file. If
you have installed the MS4W apache http server as part of the
ms4w-and-exemplar-data.zip download this would be located at:
c:\ms4w\Apache\conf\httpd.conf.</p>
<p>Check that the following modules are uncommented (by removing
the # sign from the line start).</p>
<p>Change</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="c">#LoadModule proxy_module modules/mod_proxy.so</span>
<span class="c">#LoadModule proxy_ajp_module modules/mod_proxy_ajp.so</span>
<span class="c">#LoadModule proxy_http_module modules/mod_proxy_http.so</span>
</pre></div>
</div>
<p>To:</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nb">LoadModule</span> proxy_module modules/mod_proxy.so
<span class="nb">LoadModule</span> proxy_ajp_module modules/mod_proxy_ajp.so
<span class="nb">LoadModule</span> proxy_http_module modules/mod_proxy_http.so
</pre></div>
</div>
<p>Note, we have used mod_proxy here as it is included with the
Apache HTTP Server binaries, but you could use other proxy
modules such as mod_jk if desired.</p>
<p>Now you need to add or uncomment the following directives (as
appropriate for your configuration file); we suggest adding
these directives at the end of the file for clarity.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nb">TraceEnable</span> <span class="k">off</span>
<span class="c">#Important for security!!</span>

<span class="nb">ProxyRequests</span> <span class="k">Off</span>
<span class="c">#This sets up the reverse proxy, if ’ ProxyRequests On’ is set you have a forward proxy.</span>

<span class="nb">ProxyPreserveHost</span> <span class="k">On</span>
</pre></div>
</div>
<p>Now for each service (or set of pages within a service) that
you wish to proxy you need to add the following set of
directives:</p>
<p>A &lt;Proxy&gt; or a &lt;ProxyMatch&gt; block to restrict access to your
resources, a ProxyPass directive (to map that web service into
the local server URL space), and a ProxyPassReverse directive
(which lets Apache adjust the URL in the Location,
Content-Location and URI headers on HTTP redirect responses).</p>
<p>Examples:</p>
<ol class="arabic">
<li><p>Adding a reverse proxy to the BRGM OneGeology Europe
connector for WP6 WMS. This connector runs on the Tomcat
server running on port 8080, but will appear to be running
as part of the Apache http service running on port 80.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Proxy</span> <span class="s">/1GEconnector</span><span class="nt">&gt;</span>
<span class="nb">Order</span> deny,allow
<span class="nb">Allow</span> from <span class="k">all</span>
<span class="nt">&lt;/Proxy&gt;</span>

<span class="nb">ProxyPass</span> <span class="sx">/1GEconnector</span> http://localhost:8080/1GEconnector

<span class="nb">ProxyPassReverse</span> <span class="sx">/1GEconnector</span> http://localhost:8080/1GEconnector
</pre></div>
</div>
</li>
<li><p>Adding a reverse proxy to our Jetty web service which is
running a GeoNetwork catalogue. The Jetty service is running
on port 8008 but will appear to be running as part of the
Apache http service running on port 80. You would normally
be able to use ’ localhost’ or ’ 127.0.0.1’ to specify a web
service running on the same physical server as your Apache
web server, but in this instance Jetty has been configured
to only accept requests from the server IP (194.66.252.156).</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Proxy</span> <span class="s">/geonetwork</span><span class="nt">&gt;</span>
<span class="nb">Order</span> deny,allow
<span class="nb">Allow</span> from <span class="k">all</span>
<span class="nt">&lt;/Proxy&gt;</span>

<span class="nb">ProxyPass</span> <span class="sx">/geonetwork</span> http://194.66.252.156:8008/geonetwork

<span class="nb">ProxyPassReverse</span> <span class="sx">/geonetwork</span> http://194.66.252.156:8008/geonetwork
</pre></div>
</div>
</li>
<li><p>Adding a reverse proxy to our Jetty web service which is
running an Intermap mapping client (used by the GeoNetwork
catalogue). The Jetty service is running on port 8008 but
will appear to be running as part of the Apache http service
running on port 80.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Proxy</span> <span class="s">/intermap</span><span class="nt">&gt;</span>
<span class="nb">Order</span> deny,allow
<span class="nb">Allow</span> from <span class="k">all</span>
<span class="nt">&lt;/Proxy&gt;</span>

<span class="nb">ProxyPass</span> <span class="sx">/intermap</span> http://194.66.252.156:8008/intermap

<span class="nb">ProxyPassReverse</span> <span class="sx">/intermap</span> http://194.66.252.156:8008/intermap
</pre></div>
</div>
</li>
<li><p>Adding a reverse proxy to our cocoon service, which we need
to run our WFS. The cocoon service runs on the Tomcat server
running on port 8080, but will appear to be running as part
of the Apache http service running on port 80. In this
example we are using a ProxyMatch block, which allows us to
use a regular expression to map the allowable paths to
cocoon.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;ProxyMatch</span> <span class="s">http://[^/]*/cocoon/*</span><span class="nt">&gt;</span>
<span class="nb">Order</span> deny,allow
<span class="nb">Allow</span> from <span class="m">127.0.0.1</span>
<span class="nt">&lt;/ProxyMatch&gt;</span>

<span class="nb">ProxyPass</span> <span class="sx">/cocoon</span> http://127.0.0.1:8080/cocoon/

<span class="nb">ProxyPassReverse</span> <span class="sx">/cocoon</span> http://127.0.0.1:8080/cocoon/
</pre></div>
</div>
</li>
</ol>
<p>That’s it as far as the Apache http server is concerned, but
you may also wish to configure your other web servers so that
they always proxy their http content through Apache</p>
<p>To do this in Tomcat, you need to modify a Connector block in
the server.xml configuration file as below:</p>
<p>Change:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Connector</span>
<span class="na">port=</span><span class="s">“8080”</span>
<span class="na">protocol=</span><span class="s">“HTTP/1.1”</span>
<span class="na">connectionTimeout=</span><span class="s">“20000”</span>
<span class="na">redirectPort=</span><span class="s">“8443”</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>To:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;Connector</span>
<span class="na">port=</span><span class="s">“8080”</span>
<span class="na">protocol=</span><span class="s">“HTTP/1.1”</span>
<span class="na">connectionTimeout=</span><span class="s">“20000”</span>
<span class="na">redirectPort=</span><span class="s">“8443”</span>
<span class="na">proxyName=</span><span class="s">“yourserver.org”</span>
<span class="na">proxyPort=</span><span class="s">“80”</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>ProxyName: is the domain name or IP of the standard (Apache
HTTP Server) web service and can be omitted if you are running
your Tomcat service on the same server as the http service.</p>
<p>To do this in Jetty you need to make a similar change in the
jetty.xml file</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="appendixi.html" class="btn btn-neutral float-right" title="OneGeology English keyword dictionary picklist" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="appendixg.html" class="btn btn-neutral float-left" title="WMS 1.1.1 GetCapabilities response from the BGS OneGeology exemplars service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, OneGeology.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>